<!DOCTYPE html>
<html>
<head>
  <title>Particletest</title>
  <style>
    html, body {
      width:  100%;
      height: 100%;
      margin: 0px;
      overflow: hidden;
      background-color: black;
    }
  </style>
  <script>

    var canvas;
    var ctx;
    var objs = [];
    var mousepos;
    var mode = 0;
    var paused = false;
    var autocooldown = 0;
    var shift = false;

    window.onload = function() {
      start();
    }

    function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
    }

    function spawnrocket(x, y){
      var lt = getRandomInt(30, 75);
      var speed = 10;
      while(lt*speed > y){
        lt -= getRandomInt(3, 20);
      }
      addobj(x, y, 0, 0, speed*-1, lt, getRandomColor());
    }

    function start() {
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext("2d");
      canvas.onmousemove = function(e) {
        mousepos = getMousePos(canvas, e);
      }
      canvas.onclick = function(e) {
        if(!paused && mode == 0){
          spawnrocket(mousepos.x, mousepos.y);
        }
      }
      canvas.onscroll = function(e) {
        console.log(2);
      }
      window.setInterval(update, 25);
      window.onkeydown = function(e) {
        if(e.keyCode == 16){
          shift = true;
        }
      }
      window.onkeyup = function(e) {
        if(e.keyCode == 77){
          e.preventDefault();
          if(shift && mode == 1){
            mode = 2;
          } else if(mode == 2) {
            mode = 1;
          } else {
            if(mode == 1) {
              mode = 0;
            } else if(mode == 0) {
              mode = 1;
            }
          }
        } else if(e.keyCode == 80){
          e.preventDefault();
          paused = !paused;
        } else if(e.keyCode == 16){
          shift = false;
        }
      }
    }

    function addobj(x, y, state, movex, movey, lifetime, color) {
      var obj = {x: x, y: y, state: state, movex: movex, movey: movey, lifetime: lifetime, color: color};
      objs.push(obj);
    }

    function update() {
      if(!paused) {
        for(var i = 0; i < objs.length; i++) {
          if(objs[i].x < 0 || objs[i].x > canvas.width || objs[i].y < 0 || objs[i].y > canvas.height || objs[i].lifetime <= 0){
            if(objs[i].state == 0){
              makeexp(objs[i].x, objs[i].y, objs[i].color);
            }
            objs.splice(i, 1);
          }
        }

        for(var i = 0; i < objs.length; i++) {
          objs[i].x += objs[i].movex;
          objs[i].y += objs[i].movey;
          objs[i].lifetime--;
        }

        if(mode == 1) {
          if(autocooldown == 0) {
            spawnrocket(getRandomInt(10, window.innerWidth-10), window.innerHeight - getRandomInt(0, window.innerHeight < 200 ? 50 : 200), 0, 0, -10);
            autocooldown = 2;
          } else {
            autocooldown--;
          }
        }

        if(mode == 2) {
          for(var i = 0; i < 5; i++){
            spawnrocket(getRandomInt(10, window.innerWidth-10), window.innerHeight - getRandomInt(0, window.innerHeight < 200 ? 50 : 200), 0, 0, -10);
          }
        }



      }
      draw();
    }

    function getRandomColor() {
      var letters = '0123456789ABCDEF';
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function draw() {
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      ctx.fillStyle = "rgb(0,0,0)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "white";
      ctx.font = "16px OpenSans, Sans, sans-serif";
      var modetext = "";
      if(mode == 0){
        modetext = "Manual Mode";
      } else if(mode == 1) {
        modetext = "Automatic Mode";
      } else if(mode == 2) {
        modetext = "Arabischer Modus xD";
      }
      if(paused){
        modetext += " | Paused";
      }
      ctx.fillText(modetext, 5, 20);
      for(var i = 0; i < objs.length; i++) {
        if(objs[i].state == 0) {
          ctx.beginPath();
          ctx.lineWidth="1";
          ctx.strokeStyle = "rgb(255,255,255)";
          ctx.rect(objs[i].x, objs[i].y, 5, 10);
          ctx.stroke();
        } else if(objs[i].state == 1) {
          ctx.beginPath();
          ctx.lineWidth="1";
          ctx.strokeStyle = objs[i].color;
          ctx.rect(objs[i].x, objs[i].y, 5, 5);
          ctx.stroke();
        }
      }
    }

    function makeexp(x, y, color) {
      //console.log("exp;x=" + x + ";y=" + y);

      //RECHTS UNTEN
      addobj(x, y, 1, 1, 1, getRandomInt(30, 50), color);
      addobj(x, y, 1, 2, 2, getRandomInt(30, 50), color);
      addobj(x, y, 1, 3, 3, getRandomInt(30, 50), color);

      //UNTEN
      addobj(x, y, 1, 0, 1, getRandomInt(30, 50), color);
      addobj(x, y, 1, 0, 2, getRandomInt(30, 50), color);
      addobj(x, y, 1, 0, 4, getRandomInt(30, 50), color);

      //OBEN
      addobj(x, y, 1, 0, -1, getRandomInt(30, 50), color);
      addobj(x, y, 1, 0, -2, getRandomInt(30, 50), color);
      addobj(x, y, 1, 0, -4, getRandomInt(30, 50), color);

      //LINKS UNTEN
      addobj(x, y, 1, -1, 1, getRandomInt(30, 50), color);
      addobj(x, y, 1, -2, 2, getRandomInt(30, 50), color);
      addobj(x, y, 1, -3, 3, getRandomInt(30, 50), color);

      //LINKS
      addobj(x, y, 1, -1, 0, getRandomInt(30, 50), color);
      addobj(x, y, 1, -2, 0, getRandomInt(30, 50), color);
      addobj(x, y, 1, -4, 0, getRandomInt(30, 50), color);

      //RECHTS
      addobj(x, y, 1, 1, 0, getRandomInt(30, 50), color);
      addobj(x, y, 1, 2, 0, getRandomInt(30, 50), color);
      addobj(x, y, 1, 4, 0, getRandomInt(30, 50), color);

      //LINKS OBEN
      addobj(x, y, 1, -1, -1, getRandomInt(30, 50), color);
      addobj(x, y, 1, -2, -2, getRandomInt(30, 50), color);
      addobj(x, y, 1, -3, -3, getRandomInt(30, 50), color);

      //RECHTS OBEN
      addobj(x, y, 1, 1, -1, getRandomInt(30, 50), color);
      addobj(x, y, 1, 2, -2, getRandomInt(30, 50), color);
      addobj(x, y, 1, 3, -3, getRandomInt(30, 50), color);
    }

  </script>
</head>
<body>
  <canvas id="canvas"></canvas>
</body>
</html>
